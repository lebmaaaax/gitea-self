# 02-reverse-proxy — настройка Nginx для HTTPS и красивого URL

Этот документ объясняет, зачем нужен reverse proxy, как его настроить и что важно не забыть в конфигурации Gitea.

---

## Зачем нужен reverse proxy

По умолчанию Gitea слушает порт `3000` и доступна по адресу вида `http://git.intra.local:3000`. Reverse proxy (Nginx/Caddy/Traefik) позволяет:

- Убрать порт из URL: `https://git.intra.local/` вместо `http://git.intra.local:3000`
- Добавить HTTPS с нормальным сертификатом (Let's Encrypt или корпоративный CA)
- Централизовать SSL-терминацию и политики безопасности (HSTS, rate limiting, access control)
- Выставлять несколько сервисов на одном IP через разные домены/поддомены

Gitea официально документирует работу за reverse proxy и подчеркивает: при использовании прокси нужно корректно выставить `ROOT_URL`  
Документация: https://docs.gitea.com/administration/reverse-proxies

## Архитектура с прокси
[Пользователь] → https://git.intra.local/ (443) → [Nginx на VM1:80/443]
↓
http://127.0.0.1:3000 (Gitea container)

- Nginx слушает порты `80` и `443` на внешнем интерфейсе VM1
- Gitea продолжает слушать `3000` (но только localhost/docker-сеть)
- Nginx проксирует запросы на внутренний `http://gitea:3000` или `http://127.0.0.1:3000`

---

## Требования к reverse proxy

1. **ROOT_URL должен совпадать с внешним адресом**  
В `app.ini` или переменных окружения контейнера: `ROOT_URL = https://git.intra.local/` (если пользователи заходят через HTTPS без порта)

2. **Проксировать путь корректно (не декодировать URI)**  
Gitea требует, чтобы прокси не декодировал/не перекодировал URI, иначе возможны проблемы с путями репозиториев

3. **Передавать стандартные заголовки**  
- `Host`
- `X-Real-IP`
- `X-Forwarded-For`
- `X-Forwarded-Proto`
