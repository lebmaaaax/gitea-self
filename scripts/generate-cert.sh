#!/usr/bin/env bash
set -euo pipefail

# ============================================================================
# –°–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–Ω–æ–≥–æ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è Gitea
# ============================================================================

CERT_DIR="vm1-gitea/nginx/certs"
DOMAIN="${1:-git.company.local}"
DAYS="${2:-365}"

echo "üîê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–Ω–æ–≥–æ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
echo "   –î–æ–º–µ–Ω: $DOMAIN"
echo "   –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: $DAYS –¥–Ω–µ–π"
echo ""

# –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p "$CERT_DIR"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
openssl req -x509 -nodes -days "$DAYS" -newkey rsa:2048 \
  -keyout "$CERT_DIR/${DOMAIN}.key" \
  -out "$CERT_DIR/${DOMAIN}.crt" \
  -subj "/C=RU/ST=Moscow/L=Moscow/O=Company/OU=IT/CN=${DOMAIN}" \
  -addext "subjectAltName=DNS:${DOMAIN},DNS:*.${DOMAIN}"

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
chmod 644 "$CERT_DIR/${DOMAIN}.crt"
chmod 600 "$CERT_DIR/${DOMAIN}.key"

echo ""
echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
echo ""
echo "–§–∞–π–ª—ã:"
echo "  üìÑ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: $CERT_DIR/${DOMAIN}.crt"
echo "  üîë –ö–ª—é—á:       $CERT_DIR/${DOMAIN}.key"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –≠—Ç–æ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–Ω–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç!"
echo "   –ë—Ä–∞—É–∑–µ—Ä—ã –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
echo ""
echo "–ß—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):"
echo "  1. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ –±—Ä–∞—É–∑–µ—Ä/—Å–∏—Å—Ç–µ–º—É –∫–∞–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π"
echo "  2. –ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ /etc/hosts –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –º–∞—à–∏–Ω"
echo ""
echo "–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:"
echo "  1. –û–±–Ω–æ–≤–∏—Ç–µ GITEA_ROOT_URL –≤ vm1-gitea/.env –Ω–∞ https://${DOMAIN}/"
echo "  2. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ HTTPS –±–ª–æ–∫ –≤ vm1-gitea/nginx/gitea.conf"
echo "  3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: cd vm1-gitea && docker compose restart"
